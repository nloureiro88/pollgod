<div class="container-fluid poll-list">
  <div class="row poll-list-row">

  <% @polls.each do |poll| %>

    <% sponsored = poll.qtype == 'sponsored' %>
    <% cat_color = poll.category.color %>

    <div class="poll-card col-xs-12 col-sm-6 col-md-4" style="color: <%= cat_color %> <%= '; filter: brightness(85%);' if poll.status == 'inactive' %>">

    <!-- FRONT OF CARD -->

      <div class="poll-card-front" id="poll-card-front-<%= poll.id %>" data-answered="<%= poll.answered?(current_user) %>">

        <%= render 'shared/poll_components/dropleft', object: {poll: poll}  %>

        <button class="answer-button" data-poll="<%= poll.id %>">

          <% frame_style = sponsored ? "border-color: #{cat_color}; background-color: #{cat_color}; color: white" : "border-color: #{cat_color}" %>

          <div class="poll-frame poll-frame-front" style="<%= frame_style %>" >

            <div class="poll-question">

              <div class="question-top">
                <div class="question-top-left">
                  <% image_type = sponsored ? "category_white" : "category_color" %>

                  <%= link_to ({controller: controller_name, action: action_name, query: poll.category.name}) do %>
                    <%= image_tag("#{image_type}/#{poll.category.icon}", title: "#{poll.category.name}", data: { toggle: "tooltip-bottom", placement: "bottom" }) %>
                  <% end %>
                  <p><strong><%= "#{poll.points}" %></strong> <%= "#{poll.points == 1 ? "ticket" : "tickets"}" %></p>
                </div>
                <div class="question-top-right">
                  <%= link_to ({controller: controller_name, action: action_name, query: "#{poll.user.first_name} #{poll.user.last_name}"}) do %>
                    <%= image_tag("#{poll.user.photo}", size: "36x36", class: "svg-icon", alt: "#{poll.user.first_name} #{poll.user.last_name}", title: "#{poll.user.first_name} #{poll.user.last_name}", data: { toggle: "tooltip-bottom", placement: "bottom" }) %>
                  <% end %>
                </div>
              </div>

              <div class="question-main">
                  <h4><%= poll.question %></h4>
              </div>

            </div>
          </div>

        </button>

        <div class="poll-bottom">
          <div class="poll-bottom-left">
            <p>
              <% if poll.qtype == "sponsored" %>
                <i class="fas fa-industry" title="Sponsored Poll" data-toggle="tooltip-all"></i>
              <% elsif poll.qtype == "closed" %>
                <i class="fas fa-lock" title="Closed Poll" data-toggle="tooltip-all"></i>
              <% else %>
                <i class="fas fa-lock-open" title="Open Poll" data-toggle="tooltip-all"></i>
              <% end %>

              <span title="Deadline" data-toggle="tooltip-all">
                <% if poll.deadline > Time.now %>
                  <%= poll.deadline.strftime("%d/%m") %>
                <% else %>
                  Closed
                <% end %>
              </span>
            </p>
          </div>

          <div class="poll-bottom-right">
            <p>
              <span title="Answers" data-toggle="tooltip-all">
                <i class="far fa-comment-alt"></i> <%= poll.count_answers %>
              </span>
              <span title="Upvotes" data-toggle="tooltip-all">
                <i class="far fa-thumbs-up"></i> <%= poll.t_likes %>
              </span>
            </p>
          </div>
        </div>
      </div>

    <!-- BACK OF CARD -->

      <div class="poll-card-back unflipped" id="poll-card-back-<%= poll.id %>">

        <%= render 'shared/poll_components/backarrow', object: {poll: poll}  %>
        <%= render 'shared/poll_components/dropleft', object: {poll: poll}  %>

        <%= form_tag({controller: "polls", action: "add_answer", id: poll.id}, class: "answer-form") do %>

        <div class="poll-frame poll-frame-back" style="<%= "border-color: #{cat_color}; background-color: #{cat_color}; color: white;" %>" >

          <div class="poll-answer">

            <!-- <div class="answer-top">
              <h4><%#= poll.question %></h4>
            </div> -->

            <% poll_options = poll.options.map(&:capitalize) %>
            <% button_style = "border-color: white; background-color: #{cat_color};" %>

            <div class="answer-main">
              <% poll_options.each_with_index do |po, opt| %>
              <div class="answer-option">
                <input class="form-radio" type="radio" id="poll-id-<%= poll.id %>-<%= opt %>" name="poll-id-<%= poll.id %>" value="<%= opt %>" style="<%= button_style %>" data-poll="<%= poll.id %>">
                <label for="poll-id-<%= poll.id %>-<%= opt %>"><%= po.capitalize %></label>
                <br>
              </div>
              <% end %>
            </div>
          </div>
        </div>

        <div class="answer-bottom hidden" id="answer-bottom-<%= poll.id %>">
          <div class="poll-bottom-left">
            <div class="checkbox-cont">
              <input type="checkbox" id="icon-love-<%= poll.id %>" name="icon-love-<%= poll.id %>">
              <label for="icon-love-<%= poll.id %>"><i class="fas fa-heart" title="Love" data-toggle="tooltip"></i></label>
            </div>

            <div class="checkbox-cont">
              <input type="checkbox" id="icon-funny-<%= poll.id %>" name="icon-funny-<%= poll.id %>">
              <label for="icon-funny-<%= poll.id %>"><i class="fas fa-grin-squint" title="Funny" data-toggle="tooltip"></i></label>
            </div>

            <div class="checkbox-cont">
              <input type="checkbox" id="icon-interesting-<%= poll.id %>" name="icon-interesting-<%= poll.id %>">
              <label for="icon-interesting-<%= poll.id %>"><i class="fas fa-graduation-cap" title="Interesting" data-toggle="tooltip"></i></label>
            </div>
          </div>

          <div class="poll-bottom-right">
            <input type="submit" value="Submit" class="btn btn-send" style="<%= "border-color: #{cat_color}; color: #{cat_color}" %>" data-poll="<%= poll.id %>" >
          </div>
        </div>

        <% end %>

      </div>

      <!-- STATS OF CARD -->

      <div class="poll-card-stats unflipped" id="poll-card-stats-<%= poll.id %>">

        <%= render 'shared/poll_components/backarrow', object: {poll: poll}  %>
        <%= render 'shared/poll_components/dropleft', object: {poll: poll}  %>

        <div class="poll-frame poll-frame-stats" style="<%= "border-color: #{cat_color}; background-color: #{cat_color}; color: white;" %>" >
          <canvas id="myChart-<%= poll.id %>" ></canvas>

          <% poll_options = poll.options.map { |option| option.length > 10 ? "#{option.capitalize[0,10]}.." : option.capitalize } %>

          <% answer_index = 0 %>
          <% bar_colors = Array.new(poll.options.length, 'rgba(240, 240, 240, 0.2)') %>
          <% bar_colors[answer_index] = 'rgba(240, 240, 240, 1)' %>
          <% bar_line_colors = Array.new(poll.options.length, 'rgba(240, 240, 240, 0.6)') %>

          <% if poll.options.count > 3 %>

            <!-- Bar Chart -->
              <script>
                Chart.defaults.global.defaultFontColor = 'rgba(240, 240, 240, 1)';
                Chart.defaults.global.defaultFontFamily = 'Quicksand', "Helvetica", "sans-serif";
                Chart.defaults.global.defaultFontSize = 12;

                var ctx = document.getElementById(`myChart-<%= poll.id %>`).getContext('2d');
                var myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: <%= poll_options.to_json.html_safe %>,
                        fillOpacity: .8,
                        datasets: [{
                            label: '',
                            data: <%= poll.results.values.to_json.html_safe %>,
                            backgroundColor: <%= bar_colors.to_json.html_safe %>,
                            borderColor: <%= bar_line_colors.to_json.html_safe %>,
                            borderWidth: 1
                        }]
                    },
                    animation:{
                      duration: 1
                    },
                    options: {
                      legend: {
                        display: false
                      },
                      responsive: true,
                      maintainAspectRatio: false,
                      scales: {
                          yAxes: [{
                              ticks: {
                                  beginAtZero: true,
                                  display: false
                              },
                              gridLines: {
                                  drawBorder: false,
                                  display:false
                              }
                          }],
                          xAxes: [{
                              gridLines: {
                                  display:false
                              },
                          }]
                      }
                    }
                });
              </script>
            <!--  -->

            <% else %>

            <!-- Pie Chart -->
              <script>
                Chart.defaults.global.defaultFontColor = 'rgba(240, 240, 240, 1)';
                Chart.defaults.global.defaultFontFamily = 'Quicksand', "Helvetica", "sans-serif";
                Chart.defaults.global.defaultFontSize = 12;

                var ctx = document.getElementById(`myChart-<%= poll.id %>`).getContext('2d');
                var myChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: <%= poll_options.to_json.html_safe %>,
                        datasets: [{
                            label: '',
                            data: <%= poll.results.values.to_json.html_safe %>,
                            backgroundColor: <%= [
                                "#{answer_index == 0 ? 'rgba(240, 240, 240, 1)' : 'rgba(210, 210, 210, 0.5)'}",
                                "#{answer_index == 1 ? 'rgba(240, 240, 240, 1)' : 'rgba(160, 160, 160, 0.5)'}",
                                "#{answer_index == 2 ? 'rgba(240, 240, 240, 1)' : 'rgba(110, 110, 110, 0.5)'}"
                            ].take(poll.options.length).to_json.html_safe %> ,
                            borderColor: <%= Array.new(poll.options.length, 'rgba(240, 240, 240, 1)').to_json.html_safe %>,
                            borderWidth: 1
                        }]
                    },
                    animation:{
                      duration: 1
                    },
                    options: {
                      legend: {
                        position: 'bottom',
                      },
                      responsive: true,
                      maintainAspectRatio: false
                    }
                });
              </script>
            <!--  -->

            <% end %>
        </div>



        <%# my_answer = poll.answer(current_user).last %>

        <!-- <div class="poll-bottom">
          <div class="poll-bottom-left">
            <p title="Answered On" data-toggle="tooltip-all">
              <i class="far fa-calendar-check"></i>
              <%#= my_answer.created_at.strftime("%d/%m %H:%M") %>
            </p>
          </div>

          <div class="poll-bottom-right">
            <span title="Loved" data-toggle="tooltip-all">
              <i class="fas fa-heart fa-sm" style="color: <%#= my_answer.f_love == 'true' ? 'rgb(140,140,140)' : 'rgb(230,230,230)' %>"></i>
            </span>

            <span title="Funny" data-toggle="tooltip-all">
              <i class="fas fa-grin-squint fa-sm" style="color: <%#= my_answer.f_funny == 'true' ? 'rgb(140,140,140)' : 'rgb(230,230,230)' %>"></i>
            </span>

            <span title="Interesting" data-toggle="tooltip-all">
              <i class="fas fa-graduation-cap fa-sm" style="color: <%#= my_answer.f_interest == 'true' ? 'rgb(140,140,140)' : 'rgb(230,230,230)' %>"></i>
            </span>
          </div>
        </div> -->
      </div>

    </div>

  <% end %>

  <div class="filling-empty-space-childs-polls"></div>
  <div class="filling-empty-space-childs-polls"></div>

  </div>
</div>
